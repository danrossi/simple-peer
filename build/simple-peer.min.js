!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).SimplePeer={})}(this,(function(e){"use strict";const t=new WeakMap;const s={v:[{name:"version",reg:/^(\d*)$/,format:"%s"}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name",reg:/(.*)/,format:"%s"}],i:[{name:"description",reg:/(.*)/,format:"%s"}],u:[{name:"uri",reg:/(.*)/,format:"%s"}],e:[{name:"email",reg:/(.*)/,format:"%s"}],p:[{name:"phone",reg:/(.*)/,format:"%s"}],z:[{name:"timezones",reg:/(.*)/,format:"%s"}],r:[{name:"repeats",reg:/(.*)/,format:"%s"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%d trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/,format:"%s"},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/,format:"%s"},{name:"icelite",reg:/^(ice-lite)/,format:"%s"},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/,format:"%s"},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/,format:"%s"},{name:"rtcpRsize",reg:/^(rtcp-rsize)/,format:"%s"},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/,format:"%s"},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"],reg:/(.*)/,format:"%s"}]},i=/%[sdv%]/g;function n(e){let t=1;const s=arguments,n=s.length;return e.replace(i,(e=>{if(t>=n)return e;var i=s[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(i);case"%d":return Number(i);case"%v":return""}}))}function r(e,t,s){const i=[e+"="+(t.format instanceof Function?t.format(t.push?s:s[t.name]):t.format)];if(t.names)for(let e=0;e<t.names.length;e+=1){const n=t.names[e];t.name?i.push(s[t.name][n]):i.push(s[t.names[e]])}else i.push(s[t.name]);return n.apply(null,i)}const a=["v","o","s","i","u","e","p","c","b","t","r","z","a"],o=["i","c","b","a"];function d(e){return String(Number(e))===e?Number(e):e}function c(e,t,s){const i=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:i&&!t[e.name]&&(t[e.name]={});const n=e.push?{}:i?t[e.name]:t;!function(e,t,s,i){if(i&&!s)t[i]=d(e[1]);else for(let i=0;i<s.length;i+=1)null!=e[i+1]&&(t[s[i]]=d(e[i+1]))}(s.match(e.reg),n,e.names,e.name),e.push&&t[e.push].push(n)}const h=RegExp.prototype.test.bind(/^([a-z])=(.*)/);function l(e,t){const s=t.split(/=(.+)/,2);return 2===s.length?e[s[0]]=d(s[1]):1===s.length&&t.length>1&&(e[s[0]]=void 0),e}class m{static parse(e){const t={},i=[];let n=t;return e.split(/(\r\n|\r|\n)/).filter(h).forEach((e=>{const t=e[0],r=e.slice(2);"m"===t&&(i.push({rtp:[],fmtp:[]}),n=i[i.length-1]);for(let e=0;e<(s[t]||[]).length;e+=1){const i=s[t][e];if(i.reg.test(r))return c(i,n,r)}})),t.media=i,t}static parseParams(e){return e.split(/;\s?/).reduce(l,{})}static writeConfigParams(e){return Object.keys(e).map((t=>t+"="+e[t])).join(";")}static parsePayloads(e){return e.toString().split(" ").map(Number)}static parseRemoteCandidates(e){const t=[],s=e.split(" ").map(d);for(let e=0;e<s.length;e+=3)t.push({component:s[e],ip:s[e+1],port:s[e+2]});return t}static parseImageAttributes(e){return e.split(" ").map((e=>e.substring(1,e.length-1).split(",").reduce(l,{})))}static parseSimulcastStreamList(e){return e.split(";").map((e=>e.split(",").map((e=>{let t,s=!1;return"~"!==e[0]?t=d(e):(t=d(e.substring(1,e.length)),s=!0),{scid:t,paused:s}}))))}}class p{static get supportCodecPreferences(){return"RTCRtpTransceiver"in window&&"setCodecPreferences"in window.RTCRtpTransceiver.prototype}static get supportParameters(){return"setParameters"in window.RTCRtpSender.prototype}static generateId(e=10){const t=new Uint32Array(e);return window.crypto.getRandomValues(t),t.toString("hex").slice(0,e)}static get RTCPeerConnection(){return window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection}static get RTCSessionDescription(){return window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription}static get RTCIceCandidate(){return window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate}}class u{static get isFirefox(){return navigator.userAgent.indexOf("Firefox")>-1}static get mimeTypeMap(){return{opus:"audio/opus",H264:"video/H264",VP8:"video/VP8",VP9:"video/VP9"}}static configureOpus(e,t){const s=this.merge(e,t);return delete s.maxptime,delete s.ptime,s}static merge(e,t){return Object.assign({},e,t)}static formatConfig(e){return this.writeConfigParams(e)}static formatGoogleBandwidth(e,t){return{"x-google-min-bitrate":e,"x-google-max-bitrate":t}}static formatGoogleVideoBandwidth(e,t,s){const i=this.formatGoogleBandwidth(e,t);return s&&(i["x-google-start-bitrate"]=s),i}static formatBandwidth(e){let t=e;return this.isFirefox?(t=1e3*e,[{type:"TIAS",limit:t}]):[{type:"AS",limit:t},{type:"CT",limit:t}]}static formatFmtpConfig(e,t){e.fmtp.map((e=>{e.config=this.formatConfig(e.config?this.merge(m.parseParams(e.config),t):t)}))}static setOpusConfig(e,t){let s={};if("audio"==e.type&&"opus"==e.rtp[0].codec&&t){let i={};e.fmtp[0]&&e.fmtp[0].config?i=m.parseParams(e.fmtp[0].config):e.fmtp.push({}),s=this.configureOpus(i,t),e.fmtp[0].config=this.formatConfig(s),t.maxptime&&(e.maxptime=t.maxptime),t.ptime&&(e.ptime=t.ptime)}return s}static setMaxBitrate(e,t){let s;switch(e.type){case"audio":if(t.audioBitrate){let s=this.formatGoogleBandwidth(t.audioBitrate,t.audioBitrate);e.bandwidth=this.formatBandwidth(t.audioBitrate),this.formatFmtpConfig(e,s)}break;case"video":t.maxVideoBitrate&&(s=this.formatGoogleVideoBandwidth(t.minVideoBitrate,t.maxVideoBitrate,t.startVideoBitrate),this.formatFmtpConfig(e,s),e.bandwidth=this.formatBandwidth(t.maxVideoBitrate)),t.videoFrameRate&&(e.framerate=t.videoFrameRate)}}static filterCodecs(e,t){const s=t[e.type];let i=e.rtp.filter((e=>e.codec==s.codec)),n=e.fmtp.filter((e=>i.find((t=>t.payload===e.payload)))).filter((e=>!s.level||!e.config||e.config.indexOf(s.level)>-1));s.level&&(i=i.filter((e=>n.find((t=>e.payload===t.payload))))),e.rtp=i,e.fmtp=n;let r=e.rtp.map((e=>e.payload));e.rtcpFb&&(e.rtcpFb=e.rtcpFb.filter((e=>r.indexOf(e.payload)>-1))),e.payloads=r.join(" ")}static filterCodecAndBitrate(e,t,i,n=!1){const d=t;if(d||i.maxVideoBitrate){const n=m.parse(e.sdp);n.media.map((e=>{switch(e.type){case"video":case"audio":d&&this.filterCodecs(e,t),i.opusConfig&&"audio"==e.type&&this.setOpusConfig(e,i.opusConfig),i.maxVideoBitrate&&this.setMaxBitrate(e,i)}return e})),e.sdp=class{static write(e,t={}){null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));const i=t.outerOrder||a,n=t.innerOrder||o,d=[];return i.forEach((t=>{s[t].forEach((s=>{s.name in e&&null!=e[s.name]?d.push(r(t,s,e)):s.push in e&&null!=e[s.push]&&e[s.push].forEach((e=>{d.push(r(t,s,e))}))}))})),e.media.forEach((e=>{d.push(r("m",s.m[0],e)),n.forEach((t=>{s[t].forEach((s=>{s.name in e&&null!=e[s.name]?d.push(r(t,s,e)):s.push in e&&null!=e[s.push]&&e[s.push].forEach((e=>{d.push(r(t,s,e))}))}))}))})),d.join("\r\n")+"\r\n"}}.write(n)}return e}static filterBitrate(e,t){return this.filterCodecAndBitrate(e,null,t)}static preferCodec(e,t){return e.filter((e=>e.mimeType==this.mimeTypeMap[t.codec])).filter((e=>{if(t.level){if(!e.sdpFmtpLine)return!1;const s=e.sdpFmtpLine.indexOf(t.level)>-1;return t.mode>=0?s&&e.sdpFmtpLine.indexOf("packetization-mode="+t.mode.toString())>-1:s}return!0}))}static writeConfigParams(e){return Object.keys(e).map((t=>t+"="+e[t])).join(";")}}function g(e){return e.replace(/a=ice-options:trickle\s\n/g,"")}function f(e,t){var s=new Error(e);return s.code=t,s}class _ extends class{constructor(){t.set(this,{})}on(e,s){const i=t.get(this);return i[e]||(i[e]=[]),i[e].push(s),this}once(e,t){const s=(...i)=>{this.off(e,s),t(...i)};return this.on(e,s),this}off(e,s){const i=t.get(this)[e];return i&&(null===s?i.length=0:i.splice(i.indexOf(s),1)),this}listeners(e){try{return t.get(this)[e]}catch(e){return null}}emit(e,...s){const i=t.get(this)[e];return i&&i.length?(i.forEach((t=>{t({type:e,target:this},...s)})),!0):this}emitAsync(e,...s){const i=t.get(this)[e],n=[];return i&&i.length&&i.forEach((t=>{n.push(t({type:e,target:this},...s))})),Promise.all(n)}}{constructor(e){super(),this._id=p.generateId(),this._debug("new peer %o",e),this.channelName=e.initiator?e.channelName||p.generateId(20):null,this.initiator=e.initiator||!1,this.channelConfig=e.channelConfig||_.channelConfig,this.dataSubscriber=e.dataSubscriber,this.negotiated=this.channelConfig.negotiated,this.config=u.merge(_.defaultConfig,e.config),this.offerOptions=e.offerOptions||{},this.answerOptions=e.answerOptions||{},this.sdpTransform=e.sdpTransform||(e=>e),this.streams=e.streams||(e.stream?[e.stream]:[]),this.trickle=void 0===e.trickle||e.trickle,this.allowHalfTrickle=void 0!==e.allowHalfTrickle&&e.allowHalfTrickle,this.iceCompleteTimeout=e.iceCompleteTimeout||5e3,this.minVideoBitrate=e.minVideoBitrate,this.maxVideoBitrate=e.maxVideoBitrate,this.startVideoBitrate=e.startVideoBitrate||300,this.audioBitrate=e.audioBitrate,this.videoFrameRate=e.videoFrameRate,this.opusConfig=e.opus,this.preferredCodecs=e.preferredCodecs,this.debugEnabled=e.debug||!1,this.destroyed=!1,this._connected=!1,this.remoteAddress=void 0,this.remoteFamily=void 0,this.remotePort=void 0,this.localAddress=void 0,this.localFamily=void 0,this.localPort=void 0,this._pcReady=!1,this._channelReady=!1,this._iceComplete=!1,this._iceCompleteTimer=null,this._channel=null,this._pendingCandidates=[],this._isNegotiating=!this.negotiated&&!this.initiator,this._batchedNegotiation=e.disableNegotiate||!1,this._queuedNegotiation=!1,this._sendersAwaitingStable=[],this._senderMap=new Map,this._firstStable=!0,this._closingInterval=null,this._remoteTracks=[],this._remoteStreams=[],this._chunk=null,this._cb=null,this._interval=null,this.simulcast=e.simulcast||!1,this.sendEncodings=e.sendEncodings||[{}];try{this._pc=new p.RTCPeerConnection(this.config,e.pcConstraints||null)}catch(e){return void queueMicrotask((()=>this.destroy(f(e,"ERR_PC_CONSTRUCTOR"))))}if(this._pc.oniceconnectionstatechange=()=>{this._onIceStateChange()},this._pc.onicegatheringstatechange=()=>{this._onIceStateChange()},this._pc.onconnectionstatechange=()=>{this._onConnectionStateChange()},this._pc.onsignalingstatechange=()=>{this._onSignalingStateChange()},this._pc.onicecandidate=e=>{this._onIceCandidate(e)},e.dataChannel&&(this.initiator||this.negotiated||this.dataSubscriber?this._setupData({channel:this._pc.createDataChannel(this.channelName,this.channelConfig)}):this._pc.ondatachannel=e=>{this._setupData(e)}),this.streams&&(this.streams.forEach((e=>{this.addStream(e)})),this.simulcast&&this.setVideoEncodings(this.sendEncodings),this.preferredCodecs&&this.setCodecPreferences(this.preferredCodecs)),"ontrack"in this._pc?this._pc.ontrack=e=>{this._onTrack(e)}:this._pc.onaddstream=e=>{this._onStream(e)},e.transceiverDirection){const t={direction:e.transceiverDirection};this._pc.addTransceiver("video",t),this._pc.addTransceiver("audio",t)}this.initiator&&this._needsNegotiation(),this._onFinishBound=()=>{this._onFinish()},this.once("finish",this._onFinishBound)}get bufferSize(){return this._channel&&this._channel.bufferedAmount||0}get connected(){return this._connected&&"open"===this._channel.readyState}address(){return{port:this.localPort,family:this.localFamily,address:this.localAddress}}signal(e){if(this.destroyed)throw f("cannot signal after peer is destroyed","ERR_SIGNALING");if("string"==typeof e)try{e=JSON.parse(e)}catch(t){e={}}this._debug("signal()"),e.renegotiate&&this.initiator&&(this._debug("got request to renegotiate"),this._needsNegotiation()),e.transceiverRequest&&this.initiator&&(this._debug("got request for transceiver"),this.addTransceiver(e.transceiverRequest.kind,e.transceiverRequest.init)),e.candidate&&(this._pc.remoteDescription&&this._pc.remoteDescription.type?this._addIceCandidate(e.candidate):this._pendingCandidates.push(e.candidate)),e.sdp&&(this.initiator&&this.maxVideoBitrate&&this._onFilterBitrate(e),this._pc.setRemoteDescription(new p.RTCSessionDescription(e)).then((()=>{this.destroyed||(this._pendingCandidates.forEach((e=>{this._addIceCandidate(e)})),this._pendingCandidates&&this.addIceCandidates(this._pendingCandidates),this._pendingCandidates=[],"offer"===this._pc.remoteDescription.type&&this._createAnswer())})).catch((e=>{this.destroy(f(e,"ERR_SET_REMOTE_DESCRIPTION"))}))),e.sdp||e.candidate||e.renegotiate||e.transceiverRequest||this.destroy(f("signal() called with invalid signal data","ERR_SIGNALING"))}addIceCandidates(e){e.forEach((e=>{this._addIceCandidate(e)}))}_addIceCandidate(e){var t=new p.RTCIceCandidate(e);this._pc.addIceCandidate(t).catch((e=>{var s;!t.address||t.address.endsWith(".local")?(s="Ignoring unsupported ICE candidate.",console.warn(s)):this.destroy(f(e,"ERR_ADD_ICE_CANDIDATE"))}))}send(e){this._channel.send(e)}addTransceiver(e,t){if(this._debug("addTransceiver()"),this.initiator)try{this._pc.addTransceiver(e,t),this._needsNegotiation()}catch(e){this.destroy(f(e,"ERR_ADD_TRANSCEIVER"))}else this.emit("signal",{transceiverRequest:{kind:e,init:t}})}addStream(e){if(this._debug("addStream()"),this.simulcast&&this.sendEncodings){const t={video:{sendEncodings:this.sendEncodings},audio:{}};e.getTracks().forEach((s=>{const i=Object.assign({},t[s.kind],{streams:[e]});this.addTransceiver(s,i)}))}else"addTrack"in this._pc?e.getTracks().forEach((t=>{this.addTrack(t,e)})):this._pc.addStream(e)}addTrack(e,t){this._debug("addTrack()");var s=this._senderMap.get(e)||new Map,i=s.get(t);if(i)throw i.removed?f("Track has been removed. You should enable/disable tracks that you want to re-add.","ERR_SENDER_REMOVED"):f("Track has already been added to that stream.","ERR_SENDER_ALREADY_ADDED");i=this._pc.addTrack(e,t),s.set(t,i),this._senderMap.set(e,s),this._needsNegotiation()}replaceTrack(e,t,s){this._debug("replaceTrack()");var i=this._senderMap.get(e),n=i?i.get(s):null;if(!n)throw f("Cannot replace track that was never added.","ERR_TRACK_NOT_ADDED");t&&this._senderMap.set(t,i),null!=n.replaceTrack?n.replaceTrack(t):this.destroy(f("replaceTrack is not supported in this browser","ERR_UNSUPPORTED_REPLACETRACK"))}removeTrack(e,t){this._debug("removeSender()");var s=this._senderMap.get(e),i=s?s.get(t):null;if(!i)throw f("Cannot remove track that was never added.","ERR_TRACK_NOT_ADDED");try{i.removed=!0,this._pc.removeTrack(i)}catch(e){"NS_ERROR_UNEXPECTED"===e.name?this._sendersAwaitingStable.push(i):this.destroy(f(e,"ERR_REMOVE_TRACK"))}this._needsNegotiation()}removeStream(e){this._debug("removeSenders()"),e.getTracks().forEach((t=>{this.removeTrack(t,e)}))}_needsNegotiation(){this._debug("_needsNegotiation"),this._batchedNegotiation||(this._batchedNegotiation=!0,queueMicrotask((()=>{this._batchedNegotiation=!1,this._debug("starting batched negotiation"),this.negotiate()})))}negotiate(){this.initiator?this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("start negotiation"),setTimeout((()=>{this._createOffer()}),0)):this._isNegotiating||(this._debug("requesting negotiation from initiator"),this.emit("signal",{renegotiate:!0})),this._isNegotiating=!0}destroy(e,t){if(!this.destroyed){if(this._debug("destroy (error: %s)",e&&(e.message||e)),this.destroyed=!0,this._connected=!1,this._pcReady=!1,this._channelReady=!1,this._remoteTracks=null,this._remoteStreams=null,this._senderMap=null,clearInterval(this._closingInterval),this._closingInterval=null,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this.off("finish",this._onFinishBound),this._onFinishBound=null,this._channel){try{this._channel.close()}catch(e){}this._channel.onmessage=null,this._channel.onopen=null,this._channel.onclose=null,this._channel.onerror=null}if(this._pc){try{this._pc.close()}catch(e){}this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ontrack=null,this._pc.ondatachannel=null}this._pc=null,this._channel=null,e&&this.emit("error",e),this.emit("close")}}_setupData(e){if(!e.channel)return this.destroy(f("Data channel event is missing `channel` property","ERR_DATA_CHANNEL"));this._channel=e.channel,this._channel.binaryType="arraybuffer","number"==typeof this._channel.bufferedAmountLowThreshold&&(this._channel.bufferedAmountLowThreshold=65536),this.channelName=this._channel.label,this._channel.onmessage=e=>{this._onChannelMessage(e)},this._channel.onbufferedamountlow=()=>{this._onChannelBufferedAmountLow()},this._channel.onopen=()=>{this._onChannelOpen()},this._channel.onclose=()=>{this._debug("on channel close")},this._channel.onerror=e=>{this.destroy(f(e,"ERR_DATA_CHANNEL"))};var t=!1;this._closingInterval=setInterval((()=>{this._channel&&"closing"===this._channel.readyState?(t&&this._onChannelClose(),t=!0):t=!1}),5e3)}_onFinish(){if(this.destroyed)return;const e=()=>{setTimeout((()=>this.destroy()),1e3)};this._connected?e():this.once("connect",e)}_startIceCompleteTimeout(){this.destroyed||this._iceCompleteTimer||(this._debug("started iceComplete timeout"),this._iceCompleteTimer=setTimeout((()=>{this._iceComplete||(this._iceComplete=!0,this._debug("iceComplete timeout completed"),this.emit("iceTimeout"),this.emit("_iceComplete"))}),this.iceCompleteTimeout))}_onOffer(e){if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(e.sdp=g(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const t=()=>{if(!this.destroyed){var t=this._pc.localDescription||e;this._debug("signal"),this.emit("signal",{type:t.type,sdp:t.sdp})}};this._pc.setLocalDescription(e).then((()=>{this._debug("createOffer success"),this.destroyed||(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))})).catch((e=>{this.destroy(f(e,"ERR_SET_LOCAL_DESCRIPTION"))}))}get bwConfig(){return{audioBitrate:this.audioBitrate,minVideoBitrate:this.minVideoBitrate,maxVideoBitrate:this.maxVideoBitrate,startVideoBitrate:this.startVideoBitrate,videoFrameRate:this.videoFrameRate,opusConfig:this.opusConfig}}_onFilterCodecAndBitrate(e){return u.filterCodecAndBitrate(e,this.preferredCodecs,this.bwConfig,this.codecFilterFallback)}_onFilterBitrate(e){return u.filterBitrate(e,this.bwConfig)}_createOffer(){this.destroyed||this._pc.createOffer(this.offerOptions).then((e=>this._onFilterCodecAndBitrate(e))).then((e=>this._onOffer(e))).catch((e=>{this.destroy(f(e,"ERR_CREATE_OFFER"))}))}_requestMissingTransceivers(){this._pc.getTransceivers&&this._pc.getTransceivers().forEach((e=>{e.mid||!e.sender.track||e.requested||(e.requested=!0,this.addTransceiver(e.sender.track.kind))}))}_createAnswer(){this.destroyed||this._pc.createAnswer(this.answerOptions).then((e=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(e.sdp=g(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const t=()=>{if(!this.destroyed){var t=this._pc.localDescription||e;this._debug("signal"),this.emit("signal",{type:t.type,sdp:t.sdp}),this.initiator||this._requestMissingTransceivers()}};this._pc.setLocalDescription(e).then((()=>{this.destroyed||(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))})).catch((e=>{this.destroy(f(e,"ERR_SET_LOCAL_DESCRIPTION"))}))})).catch((e=>{this.destroy(f(e,"ERR_CREATE_ANSWER"))}))}_onConnectionStateChange(){this.destroyed||"failed"===this._pc.connectionState&&this.destroy(f("Connection failed.","ERR_CONNECTION_FAILURE"))}_onIceStateChange(){if(!this.destroyed){var e=this._pc.iceConnectionState,t=this._pc.iceGatheringState;this._debug("iceStateChange (connection: %s) (gathering: %s)",e,t),this.emit("iceStateChange",e,t),"connected"!==e&&"completed"!==e||(this._pcReady=!0,this._maybeReady()),"failed"===e&&this.destroy(f("Ice connection failed.","ERR_ICE_CONNECTION_FAILURE")),"closed"===e&&this.destroy(f("Ice connection closed.","ERR_ICE_CONNECTION_CLOSED"))}}getStats(e){const t=e=>("[object Array]"===Object.prototype.toString.call(e.values)&&e.values.forEach((t=>{Object.assign(e,t)})),e);0===this._pc.getStats.length?this._pc.getStats().then((s=>{var i=[];s.forEach((e=>{i.push(t(e))})),e(null,i)}),(t=>e(t))):this._pc.getStats.length>0?this._pc.getStats((s=>{if(!this.destroyed){var i=[];s.result().forEach((e=>{var s={};e.names().forEach((t=>{s[t]=e.stat(t)})),s.id=e.id,s.type=e.type,s.timestamp=e.timestamp,i.push(t(s))})),e(null,i)}}),(t=>e(t))):e(null,[])}get senders(){return this._pc.getSenders()}getSender(e){return this.senders.filter((t=>t.track.kind==e))[0]}_maybeReady(){if(this._debug("maybeReady pc %s channel %s",this._pcReady,this._channelReady),this._connected||this._connecting||!this._pcReady||!this._channelReady)return;this._connecting=!0;const e=()=>{this.destroyed||this.getStats(((t,s)=>{if(this.destroyed)return;t&&(s=[]);var i={},n={},r={},a=!1;s.forEach((e=>{"remotecandidate"!==e.type&&"remote-candidate"!==e.type||(i[e.id]=e),"localcandidate"!==e.type&&"local-candidate"!==e.type||(n[e.id]=e),"candidatepair"!==e.type&&"candidate-pair"!==e.type||(r[e.id]=e)}));const o=e=>{a=!0;var t=n[e.localCandidateId];t&&(t.ip||t.address)?(this.localAddress=t.ip||t.address,this.localPort=Number(t.port)):t&&t.ipAddress?(this.localAddress=t.ipAddress,this.localPort=Number(t.portNumber)):"string"==typeof e.googLocalAddress&&(t=e.googLocalAddress.split(":"),this.localAddress=t[0],this.localPort=Number(t[1])),this.localAddress&&(this.localFamily=this.localAddress.includes(":")?"IPv6":"IPv4");var s=i[e.remoteCandidateId];s&&(s.ip||s.address)?(this.remoteAddress=s.ip||s.address,this.remotePort=Number(s.port)):s&&s.ipAddress?(this.remoteAddress=s.ipAddress,this.remotePort=Number(s.portNumber)):"string"==typeof e.googRemoteAddress&&(s=e.googRemoteAddress.split(":"),this.remoteAddress=s[0],this.remotePort=Number(s[1])),this.remoteAddress&&(this.remoteFamily=this.remoteAddress.includes(":")?"IPv6":"IPv4"),this._debug("connect local: %s:%s remote: %s:%s",this.localAddress,this.localPort,this.remoteAddress,this.remotePort)};if(s.forEach((e=>{"transport"===e.type&&e.selectedCandidatePairId&&o(r[e.selectedCandidatePairId]),("googCandidatePair"===e.type&&"true"===e.googActiveConnection||("candidatepair"===e.type||"candidate-pair"===e.type)&&e.selected)&&o(e)})),a||Object.keys(r).length&&!Object.keys(n).length){if(this._connecting=!1,this._connected=!0,this._chunk){try{this.send(this._chunk)}catch(t){return this.destroy(f(t,"ERR_DATA_CHANNEL"))}this._chunk=null,this._debug('sent chunk from "write before connect"');var d=this._cb;this._cb=null,d(null)}"number"!=typeof this._channel.bufferedAmountLowThreshold&&(this._interval=setInterval((()=>this._onInterval()),150),this._interval.unref&&this._interval.unref()),this._debug("connect"),this.emit("connect")}else setTimeout(e,100)}))};e()}_onInterval(){!this._cb||!this._channel||this._channel.bufferedAmount>65536||this._onChannelBufferedAmountLow()}_onSignalingStateChange(){this.destroyed||("stable"!==this._pc.signalingState||this._firstStable||(this._isNegotiating=!1,this._debug("flushing sender queue",this._sendersAwaitingStable),this._sendersAwaitingStable.forEach((e=>{this._pc.removeTrack(e),this._queuedNegotiation=!0})),this._sendersAwaitingStable=[],this._queuedNegotiation&&(this._debug("flushing negotiation queue"),this._queuedNegotiation=!1,this._needsNegotiation()),this._debug("negotiate"),this.emit("negotiate")),this._firstStable=!1,this._debug("signalingStateChange %s",this._pc.signalingState),this.emit("signalingStateChange",this._pc.signalingState))}_onIceCandidate(e){this.destroyed||(e.candidate&&this.trickle?this.emit("signal",{candidate:{candidate:e.candidate.candidate,sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid},candidateObj:e.candidate}):e.candidate||this._iceComplete||(this._iceComplete=!0,this.emit("_iceComplete")),e.candidate&&this._startIceCompleteTimeout())}_onChannelMessage(e){if(!this.destroyed){var t=e.data;this.emit("data",t)}}_onChannelBufferedAmountLow(){if(!this.destroyed&&this._cb){this._debug("ending backpressure: bufferedAmount %d",this._channel.bufferedAmount);var e=this._cb;this._cb=null,e(null)}}_onChannelOpen(){this._connected||this.destroyed||(this._debug("on channel open"),this._channelReady=!0,this._maybeReady())}_onChannelClose(){this.destroyed||(this._debug("on channel close"),this.destroy())}_onStream(e){this.emit("stream",e.stream)}_onTrack(e){this.destroyed||e.streams.forEach((t=>{this._debug("on track"),this.emit("track",e.track,t),this._remoteTracks.push({track:e.track,stream:t}),this._remoteStreams.some((e=>e.id===t.id))||(this._remoteStreams.push(t),queueMicrotask((()=>{this.emit("stream",t)})))}))}_debug(){if(this.debugEnabled){var e=[].slice.call(arguments);e[0]="["+this._id+"] "+e[0],console.log.apply(null,e)}}setCodecPreferences(e){if(this.codecFilterFallback=!1,!p.supportCodecPreferences)return;this._pc.getTransceivers().forEach((t=>{const s=t.sender.track.kind;let i=RTCRtpSender.getCapabilities(s).codecs,n=RTCRtpReceiver.getCapabilities(s).codecs,r=e[s];if(i=u.preferCodec(i,r),n=u.preferCodec(n,r),!i.length||!n.length)return void(this.codecFilterFallback=!0);const a=this.chosenPrefferredCodecs=[...i,...n];t.setCodecPreferences(a)}))}setMaxBitrate(e,t){if(!p.supportParameters)return;const s=this.getSender(e),i=s.getParameters();i.encodings||(i.encodings=[{}]),""===t?delete i.encodings[0].maxBitrate:i.encodings[0].maxBitrate=1e3*t,s.setParameters(i).then((()=>{this.emit("bitratechanged",i),console.log("Bitrate set successfully")})).catch((e=>console.error(e)))}setVideoEncodings(e){if(!p.supportParameters)return;const t=this.getSender("video"),s=t.getParameters();s.encodings=e,t.setParameters(s).then((()=>{this.emit("simulcastset",s)})).catch((e=>console.error(e)))}static get WEBRTC_SUPPORT(){return!!p.RTCPeerConnection}static get defaultConfig(){return{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:global.stun.twilio.com:3478?transport=udp"}],sdpSemantics:"unified-plan"}}static get channelConfig(){return{}}static get supportParameters(){return p.supportParameters}}e.Peer=_,Object.defineProperty(e,"__esModule",{value:!0})}));
