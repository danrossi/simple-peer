import e from"event-emitter";const t={v:[{name:"version",reg:/^(\d*)$/,format:"%d"}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name",reg:/(.*)/,format:"%s"}],i:[{name:"description",reg:/(.*)/,format:"%s"}],u:[{name:"uri",reg:/(.*)/,format:"%s"}],e:[{name:"email",reg:/(.*)/,format:"%s"}],p:[{name:"phone",reg:/(.*)/,format:"%s"}],z:[{name:"timezones",reg:/(.*)/,format:"%s"}],r:[{name:"repeats",reg:/(.*)/,format:"%s"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/,format:"%s"},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/,format:"%s"},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",reg:/(.*)/,format:"%s",names:["value"]}]},i=/%[sdv%]/g;function s(e){let t=1;const s=arguments,n=s.length;return e.replace(i,(e=>{if(t>=n)return e;var i=s[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(i);case"%d":return Number(i);case"%v":return""}}))}function n(e,t,i){const n=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(let e=0;e<t.names.length;e+=1){const s=t.names[e];t.name?n.push(i[t.name][s]):n.push(i[t.names[e]])}else n.push(i[t.name]);return s.apply(null,n)}const a=["v","o","s","i","u","e","p","c","b","t","r","z","a"],r=["i","c","b","a"];class o{static write(e,i={}){null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));const s=i.outerOrder||a,o=i.innerOrder||r,d=[];return s.forEach((i=>{t[i].forEach((t=>{t.name in e&&null!=e[t.name]?d.push(n(i,t,e)):t.push in e&&null!=e[t.push]&&e[t.push].forEach((e=>{d.push(n(i,t,e))}))}))})),e.media.forEach((e=>{d.push(n("m",t.m[0],e)),o.forEach((i=>{t[i].forEach((t=>{t.name in e&&null!=e[t.name]?d.push(n(i,t,e)):t.push in e&&null!=e[t.push]&&e[t.push].forEach((e=>{d.push(n(i,t,e))}))}))}))})),d.join("\r\n")+"\r\n"}}function d(e){return String(Number(e))===e?Number(e):e}function c(e,t,i){const s=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:s&&!t[e.name]&&(t[e.name]={});const n=e.push?{}:s?t[e.name]:t;!function(e,t,i,s){if(s&&!i)t[s]=d(e[1]);else for(let s=0;s<i.length;s+=1)null!=e[s+1]&&(t[i[s]]=d(e[s+1]))}(i.match(e.reg),n,e.names,e.name),e.push&&t[e.push].push(n)}const h=RegExp.prototype.test.bind(/^([a-z])=(.*)/);function l(e,t){const i=t.split(/=(.+)/,2);return 2===i.length?e[i[0]]=d(i[1]):1===i.length&&t.length>1&&(e[i[0]]=void 0),e}class m{static parse(e){const i={},s=[];let n=i;return e.split(/(\r\n|\r|\n)/).filter(h).forEach((e=>{const i=e[0],a=e.slice(2);"m"===i&&(s.push({rtp:[],fmtp:[]}),n=s[s.length-1]);for(let e=0;e<(t[i]||[]).length;e+=1){const s=t[i][e];if(s.reg.test(a))return c(s,n,a)}})),i.media=s,i}static parseParams(e){return e.split(/;\s?/).reduce(l,{})}static writeConfigParams(e){return Object.keys(e).map((t=>t+"="+e[t])).join(";")}static parsePayloads(e){return e.toString().split(" ").map(Number)}static parseRemoteCandidates(e){const t=[],i=e.split(" ").map(d);for(let e=0;e<i.length;e+=3)t.push({component:i[e],ip:i[e+1],port:i[e+2]});return t}static parseImageAttributes(e){return e.split(" ").map((e=>e.substring(1,e.length-1).split(",").reduce(l,{})))}static parseSimulcastStreamList(e){return e.split(";").map((e=>e.split(",").map((e=>{let t,i=!1;return"~"!==e[0]?t=d(e):(t=d(e.substring(1,e.length)),i=!0),{scid:t,paused:i}}))))}}class p{static get supportCodecPreferences(){return"RTCRtpTransceiver"in window&&"setCodecPreferences"in window.RTCRtpTransceiver.prototype}static get supportParameters(){return"setParameters"in window.RTCRtpSender.prototype}static generateId(e=10){const t=new Uint32Array(e);return window.crypto.getRandomValues(t),t.toString("hex").slice(0,e)}static get RTCPeerConnection(){return window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection}static get RTCSessionDescription(){return window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription}static get RTCIceCandidate(){return window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate}}class u{static get isFirefox(){return navigator.userAgent.indexOf("Firefox")>-1}static async parse(e){return new Promise((t=>{t(m.parse(e.sdp))}))}static async write(e){return new Promise((t=>{t(o.write(e))}))}static get mimeTypeMap(){return{opus:"audio/opus",H264:"video/H264",VP8:"video/VP8",VP9:"video/VP9"}}static configureOpus(e,t){const i=this.merge(e,t);return delete i.maxptime,delete i.ptime,i}static merge(e,t){return Object.assign({},e,t)}static formatConfig(e){return this.writeConfigParams(e)}static formatGoogleBandwidth(e,t){return{"x-google-min-bitrate":e,"x-google-max-bitrate":t}}static formatGoogleVideoBandwidth(e,t,i){const s=this.formatGoogleBandwidth(e,t);return i&&(s["x-google-start-bitrate"]=i),s}static formatBandwidth(e){let t=e;return this.isFirefox?(t=1e3*e,[{type:"TIAS",limit:t}]):[{type:"AS",limit:t},{type:"CT",limit:t}]}static formatFmtpConfig(e,t){e.fmtp.map((e=>{e.config=this.formatConfig(e.config?this.merge(m.parseParams(e.config),t):t)}))}static setOpusConfig(e,t,i=null){let s={};if("audio"==e.type&&"opus"==e.rtp[0].codec&&t){let n={};e.fmtp[0]&&e.fmtp[0].config?n=m.parseParams(e.fmtp[0].config):e.fmtp.push({}),s=this.configureOpus(n,t),e.fmtp[0].config=this.formatConfig(s),t.maxptime&&(e.maxptime=t.maxptime),t.ptime&&(e.ptime=t.ptime),i>2&&(e.rtp[0].codec="multiopus",e.rtp[0].encoding=i)}return s}static setMaxBitrate(e,t){let i;switch(e.type){case"audio":if(t.audioBitrate){let i=this.formatGoogleBandwidth(t.audioBitrate,t.audioBitrate);e.bandwidth=this.formatBandwidth(t.audioBitrate),this.formatFmtpConfig(e,i)}break;case"video":t.maxVideoBitrate&&(i=this.formatGoogleVideoBandwidth(t.minVideoBitrate,t.maxVideoBitrate,t.startVideoBitrate),this.formatFmtpConfig(e,i),e.bandwidth=this.formatBandwidth(t.maxVideoBitrate)),t.videoFrameRate&&(e.framerate=t.videoFrameRate)}}static filterCodecs(e,t){const i=t[e.type];let s=e.rtp.filter((e=>e.codec==i.codec)),n=e.fmtp.filter((e=>s.find((t=>t.payload===e.payload)))).filter((e=>!i.level||!e.config||e.config.indexOf(i.level)>-1));i.level&&(s=s.filter((e=>n.find((t=>e.payload===t.payload))))),e.rtp=s,e.fmtp=n;let a=e.rtp.map((e=>e.payload));e.rtcpFb&&(e.rtcpFb=e.rtcpFb.filter((e=>a.indexOf(e.payload)>-1))),e.payloads=a.join(" ")}static addExtensions(e,t=[]){let i=e.ext.reduce(((e,t)=>e>t.value?e:t.value),0)+1;const s=t.map((e=>({value:i++,uri:e})));e.ext=[...e.ext,...s]}static filterCodecAndBitrate(e,t,i,s=[],n=!1){const a=(!p.supportCodecPreference||n)&&t,r=s.length;if(a||i.maxVideoBitrate||i.opusConfig||r){const n=m.parse(e.sdp);n.media.map((e=>{switch(e.type){case"video":case"audio":a&&this.filterCodecs(e,t),i.opusConfig&&"audio"==e.type&&this.setOpusConfig(e,i.opusConfig,i.opusChannels),i.maxVideoBitrate&&this.setMaxBitrate(e,i),r&&this.addExtensions(e,s)}return e})),e.sdp=o.write(n)}return e}static filterBitrate(e,t){return this.filterCodecAndBitrate(e,null,t)}static preferCodec(e,t){return e.filter((e=>e.mimeType==this.mimeTypeMap[t.codec])).filter((e=>{if(t.level){if(!e.sdpFmtpLine)return!1;const i=e.sdpFmtpLine.indexOf(t.level)>-1;return t.mode>=0?i&&e.sdpFmtpLine.indexOf("packetization-mode="+t.mode.toString())>-1:i}return!0}))}static writeConfigParams(e){return Object.keys(e).map((t=>t+"="+e[t])).join(";")}}function g(e){return e.replace(/a=ice-options:trickle\s\n/g,"")}function f(e,t){var i=new Error(e);return i.code=t,i}class _ extends e{constructor(e){super(),this._id=p.generateId(),this._debug("new peer %o",e),this.channelName=e.initiator?e.channelName||p.generateId(20):null,this.initiator=e.initiator||!1,this.channelConfig=e.channelConfig||_.channelConfig,this.dataSubscriber=e.dataSubscriber,this.negotiated=this.channelConfig.negotiated,this.config=u.merge(_.defaultConfig,e.config),this.offerOptions=e.offerOptions||{},this.answerOptions=e.answerOptions||{},this.sdpTransform=e.sdpTransform||(e=>e),this.streams=e.streams||(e.stream?[e.stream]:[]),this.trickle=void 0===e.trickle||e.trickle,this.allowHalfTrickle=void 0!==e.allowHalfTrickle&&e.allowHalfTrickle,this.iceCompleteTimeout=e.iceCompleteTimeout||5e3,this.minVideoBitrate=e.minVideoBitrate,this.maxVideoBitrate=e.maxVideoBitrate,this.startVideoBitrate=e.startVideoBitrate||300,this.audioBitrate=e.audioBitrate,this.videoFrameRate=e.videoFrameRate,this.opusConfig=e.opus,this.opusChannels=e.opusChannels,this.preferredCodecs=e.preferredCodecs,this.disableVideo=e.disableVideo,this.disableAudio=e.disableAudio,this.transceiverTracks=void 0!==e.transceiverTracks&&e.transceiverTracks,this.extensions=e.extensions||[],this.debugEnabled=e.debug||!1,this.destroyed=!1,this._connected=!1,this.remoteAddress=void 0,this.remoteFamily=void 0,this.remotePort=void 0,this.localAddress=void 0,this.localFamily=void 0,this.localPort=void 0,this._pcReady=!1,this._channelReady=!1,this._iceComplete=!1,this._iceCompleteTimer=null,this._channel=null,this._pendingCandidates=[],this._isNegotiating=!this.negotiated&&!this.initiator,this._batchedNegotiation=e.disableNegotiate||!1,this._queuedNegotiation=!1,this._sendersAwaitingStable=[],this._senderMap=new Map,this._firstStable=!0,this._closingInterval=null,this._remoteTracks=[],this._remoteStreams=[],this._chunk=null,this._cb=null,this._interval=null,this.simulcast=e.simulcast||!1,this.sendEncodings=e.sendEncodings||[];try{this._pc=new p.RTCPeerConnection(this.config,e.pcConstraints||null)}catch(e){return void queueMicrotask((()=>this.destroy(f(e,"ERR_PC_CONSTRUCTOR"))))}if(this._pc.oniceconnectionstatechange=()=>{this._onIceStateChange()},this._pc.onicegatheringstatechange=()=>{this._onIceStateChange()},this._pc.onconnectionstatechange=()=>{this._onConnectionStateChange()},this._pc.onsignalingstatechange=()=>{this._onSignalingStateChange()},this._pc.onicecandidate=e=>{this._onIceCandidate(e)},this._pc.onnegotiationneeded=()=>{this.emit("negotiationneeded")},e.dataChannel&&(this.initiator||this.negotiated||this.dataSubscriber?this._setupData({channel:this._pc.createDataChannel(this.channelName,this.channelConfig)}):this._pc.ondatachannel=e=>{this._setupData(e)}),this.streams&&(this.streams.forEach((e=>{this.addStream(e)})),this.simulcast&&this.sendEncodings.length&&this.setVideoEncodings(this.sendEncodings),this.preferredCodecs&&this.setCodecPreferences(this.preferredCodecs)),"ontrack"in this._pc?this._pc.ontrack=e=>{this._onTrack(e)}:this._pc.onaddstream=e=>{this._onStream(e)},e.transceiverDirection){const t={direction:e.transceiverDirection};this._pc.addTransceiver("video",t),this._pc.addTransceiver("audio",t)}this.initiator&&this._needsNegotiation(),this._onFinishBound=()=>{this._onFinish()},this.once("finish",this._onFinishBound)}get bufferSize(){return this._channel&&this._channel.bufferedAmount||0}get connected(){return this._connected&&"open"===this._channel.readyState}address(){return{port:this.localPort,family:this.localFamily,address:this.localAddress}}signal(e){if(this.destroyed)throw f("cannot signal after peer is destroyed","ERR_SIGNALING");if("string"==typeof e)try{e=JSON.parse(e)}catch(t){e={}}this._debug("signal()"),e.renegotiate&&this.initiator&&(this._debug("got request to renegotiate"),this._needsNegotiation()),e.transceiverRequest&&this.initiator&&(this._debug("got request for transceiver"),this.addTransceiver(e.transceiverRequest.kind,e.transceiverRequest.init)),e.candidate&&(this._pc.remoteDescription&&this._pc.remoteDescription.type?this._addIceCandidate(e.candidate):this._pendingCandidates.push(e.candidate)),e.sdp&&(this.initiator&&this.maxVideoBitrate&&this._onFilterBitrate(e),this._pc.setRemoteDescription(new p.RTCSessionDescription(e)).then((()=>{this.destroyed||(this._pendingCandidates.forEach((e=>{this._addIceCandidate(e)})),this._pendingCandidates&&this.addIceCandidates(this._pendingCandidates),this._pendingCandidates=[],"offer"===this._pc.remoteDescription.type&&this._createAnswer())})).catch((e=>{this.destroy(f(e,"ERR_SET_REMOTE_DESCRIPTION"))}))),e.sdp||e.candidate||e.renegotiate||e.transceiverRequest||this.destroy(f("signal() called with invalid signal data","ERR_SIGNALING"))}addIceCandidates(e){e.forEach((e=>{this._addIceCandidate(e)}))}_addIceCandidate(e){var t=new p.RTCIceCandidate(e);this._pc.addIceCandidate(t).catch((e=>{var i;!t.address||t.address.endsWith(".local")?(i="Ignoring unsupported ICE candidate.",console.warn(i)):this.destroy(f(e,"ERR_ADD_ICE_CANDIDATE"))}))}send(e){this._channel.send(e)}addTransceiver(e,t){if(this._debug("addTransceiver()"),this.initiator)try{this._pc.addTransceiver(e,t),this._needsNegotiation()}catch(e){this.destroy(f(e,"ERR_ADD_TRANSCEIVER"))}else this.emit("signal",{transceiverRequest:{kind:e,init:t}})}addStream(e){if(this._debug("addStream()"),this.transceiverTracks){const t={video:{direction:this.disableVideo?"inactive":"sendonly"},audio:{direction:this.disableAudio?"inactive":"sendonly"}};this.simulcast&&this.sendEncodings.length&&(t.video.sendEncodings=this.sendEncodings),e.getTracks().forEach((i=>{const s=Object.assign({},t[i.kind],{streams:[e]});this.addTransceiver(i,s)}))}else"addTrack"in this._pc?e.getTracks().forEach((t=>{this.addTrack(t,e)})):this._pc.addStream(e)}addTrack(e,t){this._debug("addTrack()");var i=this._senderMap.get(e)||new Map,s=i.get(t);if(s)throw s.removed?f("Track has been removed. You should enable/disable tracks that you want to re-add.","ERR_SENDER_REMOVED"):f("Track has already been added to that stream.","ERR_SENDER_ALREADY_ADDED");s=this._pc.addTrack(e,t),i.set(t,s),this._senderMap.set(e,i),this._needsNegotiation()}replaceTrack(e,t,i){this._debug("replaceTrack()");var s=this._senderMap.get(e),n=s?s.get(i):null;n?(t&&this._senderMap.set(t,s),null!=n.replaceTrack?n.replaceTrack(t):this.destroy(f("replaceTrack is not supported in this browser","ERR_UNSUPPORTED_REPLACETRACK"))):this.addTrack(t,i)}removeTrack(e,t){this._debug("removeSender()");var i=this._senderMap.get(e),s=i?i.get(t):null;if(!s)throw f("Cannot remove track that was never added.","ERR_TRACK_NOT_ADDED");try{s.removed=!0,this._pc.removeTrack(s)}catch(e){"NS_ERROR_UNEXPECTED"===e.name?this._sendersAwaitingStable.push(s):this.destroy(f(e,"ERR_REMOVE_TRACK"))}this._needsNegotiation()}removeStream(e){this._debug("removeSenders()"),e.getTracks().forEach((t=>{this.removeTrack(t,e)}))}_needsNegotiation(){this._debug("_needsNegotiation"),this._batchedNegotiation||(this._batchedNegotiation=!0,queueMicrotask((()=>{this._batchedNegotiation=!1,this._debug("starting batched negotiation"),this.negotiate()})))}negotiate(){this.initiator?this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("start negotiation"),setTimeout((()=>{this._createOffer()}),0)):this._isNegotiating||(this._debug("requesting negotiation from initiator"),this.emit("signal",{renegotiate:!0})),this._isNegotiating=!0}destroy(e,t){if(!this.destroyed){if(this._debug("destroy (error: %s)",e&&(e.message||e)),this.destroyed=!0,this._connected=!1,this._pcReady=!1,this._channelReady=!1,this._remoteTracks=null,this._remoteStreams=null,this._senderMap=null,clearInterval(this._closingInterval),this._closingInterval=null,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this.off("finish",this._onFinishBound),this._onFinishBound=null,this._channel){try{this._channel.close()}catch(e){}this._channel.onmessage=null,this._channel.onopen=null,this._channel.onclose=null,this._channel.onerror=null}if(this._pc){try{this._pc.close()}catch(e){}this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ontrack=null,this._pc.ondatachannel=null}this._pc=null,this._channel=null,e&&this.emit("error",e),this.emit("close")}}_setupData(e){if(!e.channel)return this.destroy(f("Data channel event is missing `channel` property","ERR_DATA_CHANNEL"));this._channel=e.channel,this._channel.binaryType="arraybuffer","number"==typeof this._channel.bufferedAmountLowThreshold&&(this._channel.bufferedAmountLowThreshold=65536),this.channelName=this._channel.label,this._channel.onmessage=e=>{this._onChannelMessage(e)},this._channel.onbufferedamountlow=()=>{this._onChannelBufferedAmountLow()},this._channel.onopen=()=>{this._onChannelOpen()},this._channel.onclose=()=>{this._debug("on channel close")},this._channel.onerror=e=>{"closed"!=this._channel.readyState&&this.destroy(f(e,"ERR_DATA_CHANNEL"))}}_onFinish(){if(this.destroyed)return;const e=()=>{setTimeout((()=>this.destroy()),1e3)};this._connected?e():this.once("connect",e)}_startIceCompleteTimeout(){this.destroyed||this._iceCompleteTimer||(this._debug("started iceComplete timeout"),this._iceCompleteTimer=setTimeout((()=>{this._iceComplete||(this._iceComplete=!0,this._debug("iceComplete timeout completed"),this.emit("iceTimeout"),this.emit("_iceComplete"))}),this.iceCompleteTimeout))}_onOffer(e){if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(e.sdp=g(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const t=()=>{if(!this.destroyed){var t=this._pc.localDescription||e;this._debug("signal"),this.emit("signal",{type:t.type,sdp:t.sdp})}};this._pc.setLocalDescription(e).then((()=>{this._debug("createOffer success"),this.destroyed||(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))})).catch((e=>{this.destroy(f(e,"ERR_SET_LOCAL_DESCRIPTION"))}))}get bwConfig(){return{audioBitrate:this.audioBitrate,minVideoBitrate:this.minVideoBitrate,maxVideoBitrate:this.maxVideoBitrate,startVideoBitrate:this.startVideoBitrate,videoFrameRate:this.videoFrameRate,opusConfig:this.opusConfig,opusChannels:this.opusChannels}}_onFilterCodecAndBitrate(e){return u.filterCodecAndBitrate(e,this.preferredCodecs,this.bwConfig,this.extensions,this.codecFilterFallback)}_onFilterBitrate(e){return u.filterBitrate(e,this.bwConfig)}_createOffer(){this._pc.createOffer(this.offerOptions).then((e=>this._onFilterCodecAndBitrate(e))).then((e=>this._onOffer(e))).catch((e=>{this.destroy(f(e,"ERR_CREATE_OFFER"))}))}_requestMissingTransceivers(){this._pc.getTransceivers&&this._pc.getTransceivers().forEach((e=>{e.mid||!e.sender.track||e.requested||(e.requested=!0,this.addTransceiver(e.sender.track.kind))}))}_createAnswer(){this.destroyed||this._pc.createAnswer(this.answerOptions).then((e=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(e.sdp=g(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const t=()=>{if(!this.destroyed){var t=this._pc.localDescription||e;this._debug("signal"),this.emit("signal",{type:t.type,sdp:t.sdp}),this.initiator||this._requestMissingTransceivers()}};this._pc.setLocalDescription(e).then((()=>{this.destroyed||(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))})).catch((e=>{this.destroy(f(e,"ERR_SET_LOCAL_DESCRIPTION"))}))})).catch((e=>{this.destroy(f(e,"ERR_CREATE_ANSWER"))}))}_onConnectionStateChange(){this.destroyed||"failed"===this._pc.connectionState&&this.destroy(f("Connection failed.","ERR_CONNECTION_FAILURE"))}_onIceStateChange(){if(!this.destroyed){var e=this._pc.iceConnectionState,t=this._pc.iceGatheringState;this._debug("iceStateChange (connection: %s) (gathering: %s)",e,t),this.emit("iceStateChange",e,t),"connected"!==e&&"completed"!==e||(this._pcReady=!0,this._maybeReady()),"failed"===e&&this.destroy(f("Ice connection failed.","ERR_ICE_CONNECTION_FAILURE")),"closed"===e&&this.destroy(f("Ice connection closed.","ERR_ICE_CONNECTION_CLOSED"))}}getStats(e){const t=e=>("[object Array]"===Object.prototype.toString.call(e.values)&&e.values.forEach((t=>{Object.assign(e,t)})),e);0===this._pc.getStats.length?this._pc.getStats().then((i=>{var s=[];i.forEach((e=>{s.push(t(e))})),e(null,s)}),(t=>e(t))):this._pc.getStats.length>0?this._pc.getStats((i=>{if(!this.destroyed){var s=[];i.result().forEach((e=>{var i={};e.names().forEach((t=>{i[t]=e.stat(t)})),i.id=e.id,i.type=e.type,i.timestamp=e.timestamp,s.push(t(i))})),e(null,s)}}),(t=>e(t))):e(null,[])}get senders(){return this._pc.getSenders()}getSender(e){return this.senders.filter((t=>t.track.kind==e))[0]}_maybeReady(){if(this._debug("maybeReady pc %s channel %s",this._pcReady,this._channelReady),this._connected||this._connecting||!this._pcReady||!this._channelReady)return;this._connecting=!0;const e=()=>{this.destroyed||this.getStats(((t,i)=>{if(this.destroyed)return;t&&(i=[]);var s={},n={},a={},r=!1;i.forEach((e=>{"remotecandidate"!==e.type&&"remote-candidate"!==e.type||(s[e.id]=e),"localcandidate"!==e.type&&"local-candidate"!==e.type||(n[e.id]=e),"candidatepair"!==e.type&&"candidate-pair"!==e.type||(a[e.id]=e)}));const o=e=>{r=!0;var t=n[e.localCandidateId];t&&(t.ip||t.address)?(this.localAddress=t.ip||t.address,this.localPort=Number(t.port)):t&&t.ipAddress?(this.localAddress=t.ipAddress,this.localPort=Number(t.portNumber)):"string"==typeof e.googLocalAddress&&(t=e.googLocalAddress.split(":"),this.localAddress=t[0],this.localPort=Number(t[1])),this.localAddress&&(this.localFamily=this.localAddress.includes(":")?"IPv6":"IPv4");var i=s[e.remoteCandidateId];i&&(i.ip||i.address)?(this.remoteAddress=i.ip||i.address,this.remotePort=Number(i.port)):i&&i.ipAddress?(this.remoteAddress=i.ipAddress,this.remotePort=Number(i.portNumber)):"string"==typeof e.googRemoteAddress&&(i=e.googRemoteAddress.split(":"),this.remoteAddress=i[0],this.remotePort=Number(i[1])),this.remoteAddress&&(this.remoteFamily=this.remoteAddress.includes(":")?"IPv6":"IPv4"),this._debug("connect local: %s:%s remote: %s:%s",this.localAddress,this.localPort,this.remoteAddress,this.remotePort)};if(i.forEach((e=>{"transport"===e.type&&e.selectedCandidatePairId&&o(a[e.selectedCandidatePairId]),("googCandidatePair"===e.type&&"true"===e.googActiveConnection||("candidatepair"===e.type||"candidate-pair"===e.type)&&e.selected)&&o(e)})),r||Object.keys(a).length&&!Object.keys(n).length){if(this._connecting=!1,this._connected=!0,this._chunk){try{this.send(this._chunk)}catch(t){return this.destroy(f(t,"ERR_DATA_CHANNEL"))}this._chunk=null,this._debug('sent chunk from "write before connect"');var d=this._cb;this._cb=null,d(null)}"number"!=typeof this._channel.bufferedAmountLowThreshold&&(this._interval=setInterval((()=>this._onInterval()),150),this._interval.unref&&this._interval.unref()),this._debug("connect"),this.emit("connect")}else setTimeout(e,100)}))};e()}_onInterval(){!this._cb||!this._channel||this._channel.bufferedAmount>65536||this._onChannelBufferedAmountLow()}_onSignalingStateChange(){this.destroyed||("stable"!==this._pc.signalingState||this._firstStable||(this._isNegotiating=!1,this._debug("flushing sender queue",this._sendersAwaitingStable),this._sendersAwaitingStable.forEach((e=>{this._pc.removeTrack(e),this._queuedNegotiation=!0})),this._sendersAwaitingStable=[],this._queuedNegotiation&&(this._debug("flushing negotiation queue"),this._queuedNegotiation=!1,this._needsNegotiation()),this._debug("negotiate"),this.emit("negotiate")),this._firstStable=!1,this._debug("signalingStateChange %s",this._pc.signalingState),this.emit("signalingStateChange",this._pc.signalingState))}_onIceCandidate(e){this.destroyed||(e.candidate&&this.trickle?this.emit("signal",{candidate:{candidate:e.candidate.candidate,sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid},candidateObj:e.candidate}):e.candidate||this._iceComplete||(this._iceComplete=!0,this.emit("_iceComplete")),e.candidate&&this._startIceCompleteTimeout())}_onChannelMessage(e){if(!this.destroyed){var t=e.data;this.emit("data",t)}}_onChannelBufferedAmountLow(){if(!this.destroyed&&this._cb){this._debug("ending backpressure: bufferedAmount %d",this._channel.bufferedAmount);var e=this._cb;this._cb=null,e(null)}}_onChannelOpen(){this._connected||this.destroyed||(this._debug("on channel open"),this.emit("channelopen",this._channel),this._channelReady=!0,this._maybeReady())}_onChannelClose(){this.destroyed||this._debug("on channel close")}_onStream(e){this.emit("stream",e.stream)}_onTrack(e){this.destroyed||e.streams.forEach((t=>{this._debug("on track"),this.emit("track",e.track,t,e.transceiver),this._remoteTracks.push({track:e.track,stream:t,transceiver:e.transceiver}),this._remoteStreams.some((e=>e.id===t.id))||(this._remoteStreams.push(t),queueMicrotask((()=>{this.emit("stream",t)})))}))}_debug(){if(this.debugEnabled){var e=[].slice.call(arguments);e[0]="["+this._id+"] "+e[0],console.log.apply(null,e)}}setCodecPreferences(e){if(this.codecFilterFallback=!1,!p.supportCodecPreferences)return;this._pc.getTransceivers().forEach((t=>{const i=t.sender.track.kind;let s=RTCRtpSender.getCapabilities(i).codecs,n=RTCRtpReceiver.getCapabilities(i).codecs,a=e[i];if(s=u.preferCodec(s,a),n=u.preferCodec(n,a),!s.length||!n.length)return void(this.codecFilterFallback=!0);const r=this.chosenPrefferredCodecs=[...s,...n];t.setCodecPreferences(r)}))}setMaxBitrate(e,t){if(!p.supportParameters)return;const i=this.getSender(e),s=i.getParameters();s.encodings||(s.encodings=[{}]),""===t?delete s.encodings[0].maxBitrate:s.encodings[0].maxBitrate=1e3*t,i.setParameters(s).then((()=>{this.emit("bitratechanged",s),console.log("Bitrate set successfully")})).catch((e=>console.error(e)))}setVideoEncodings(e){if(!p.supportParameters)return;const t=this.getSender("video"),i=t.getParameters();i.encodings=e,t.setParameters(i).then((()=>{this.emit("simulcastset",i)})).catch((e=>console.error(e)))}static get WEBRTC_SUPPORT(){return!!p.RTCPeerConnection}static get defaultConfig(){return{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:global.stun.twilio.com:3478?transport=udp"}],sdpSemantics:"unified-plan"}}static get channelConfig(){return{}}static get supportParameters(){return p.supportParameters}}export{_ as Peer,u as SDPUtils};
